function dls_ltb

% 
% Diamond Linac to Booster transfer line
% converted from MAD file received from NGW  
% IM 19/04/2005
%
% Changes:
% JR changed effective quad lengths

global THERING GLOBVAL

GLOBVAL.E0 = 0.1e9;
GLOBVAL.LatticeFile = 'dls_ltb';

disp(' ');
disp('** Loading Diamond LTB **');

% drifts
BOOINJDRIFTs        = {atdrift('BOOINJDRIFTs',0.0129,'DriftPass')};
% the above was changed from 0.0141m to match the values in AP-BST-0050
BOOINJKICKDRIFT1s   = {atdrift('BOOINJKICKDRIFT1s',0.134,'DriftPass')};
BOOINJKICKDRIFT2s   = {atdrift('BOOINJKICKDRIFT2s',0.151,'DriftPass')};
BOOINJSEPTDRIFTs    = {atdrift('BOOINJSEPTDRIFTs',0.1381,'DriftPass')};
% the above drift was changed from 0.1369m, to match the values in
% AP-BST-0050
L2BSTRAIGHT10s      = {atdrift('L2BSTRAIGHT10s' ,0.255,'DriftPass')};
L2BSTRAIGHT11As     = {atdrift('L2BSTRAIGHT11As' ,0.04,'DriftPass')};
L2BSTRAIGHT11Bs     = {atdrift('L2BSTRAIGHT11Bs' ,0.3614,'DriftPass')};
L2BSTRAIGHT11Cs     = {atdrift('L2BSTRAIGHT11Cs' ,0.0461,'DriftPass')};
L2BSTRAIGHT1As      = {atdrift('L2BSTRAIGHT1As' ,0.04133,'DriftPass')};
L2BSTRAIGHT1Bs      = {atdrift('L2BSTRAIGHT1Bs' ,0.01275,'DriftPass')};
L2BSTRAIGHT1Cs      = {atdrift('L2BSTRAIGHT1Cs' ,0.02042,'DriftPass')};
L2BSTRAIGHT2s       = {atdrift('L2BSTRAIGHT2s' ,0.046,'DriftPass')};
L2BSTRAIGHT3As      = {atdrift('L2BSTRAIGHT3As' ,0.02523,'DriftPass')};
L2BSTRAIGHT3Bs      = {atdrift('L2BSTRAIGHT3Bs' ,0.0177,'DriftPass')};
L2BSTRAIGHT3Cs      = {atdrift('L2BSTRAIGHT3Cs' ,0.08457,'DriftPass')};
L2BSTRAIGHT4s       = {atdrift('L2BSTRAIGHT4s' ,0.1515,'DriftPass')};
L2BSTRAIGHT5As      = {atdrift('L2BSTRAIGHT5As' ,0.0425,'DriftPass')};
L2BSTRAIGHT5Bs      = {atdrift('L2BSTRAIGHT5Bs' ,0.0305,'DriftPass')};
L2BSTRAIGHT5Cs      = {atdrift('L2BSTRAIGHT5Cs' ,0.035,'DriftPass')};
L2BSTRAIGHT6As      = {atdrift('L2BSTRAIGHT6As' ,0.09523,'DriftPass')};
L2BSTRAIGHT6Bs      = {atdrift('L2BSTRAIGHT6Bs' ,0.07977,'DriftPass')};
L2BSTRAIGHT7As      = {atdrift('L2BSTRAIGHT7As' ,0.06438,'DriftPass')};
L2BSTRAIGHT7Bs      = {atdrift('L2BSTRAIGHT7Bs' ,0.07812,'DriftPass')};
L2BSTRAIGHT7Cs      = {atdrift('L2BSTRAIGHT7Cs' ,0.035,'DriftPass')};
L2BSTRAIGHT8As      = {atdrift('L2BSTRAIGHT8As' ,0.032825,'DriftPass')};
L2BSTRAIGHT8Bs      = {atdrift('L2BSTRAIGHT8Bs' ,0.291375,'DriftPass')};
L2BSTRAIGHT8Cs      = {atdrift('L2BSTRAIGHT8Cs' ,0.0608,'DriftPass')};
L2BSTRAIGHT8WALLs   = {atdrift('L2BSTRAIGHT8WALLs' ,0.12,'DriftPass')};
L2BSTRAIGHT9As      = {atdrift('L2BSTRAIGHT9As' ,0.0175,'DriftPass')};
L2BSTRAIGHT9Bs      = {atdrift('L2BSTRAIGHT9Bs' ,0.2075,'DriftPass')};
L2BSTRAIGHT9Cs      = {atdrift('L2BSTRAIGHT9Cs' ,0.025,'DriftPass')};
CORRECTORDRIFT      = {atdrift('CORRECTORDRIFT' ,0.025,'DriftPass')};

% Quads - JR fixed length and set matched values
DQUD        =  {atquadrupole('QUAD' , 0.34, -1.016147, 'QuadLinearPass')};
% Machine values on 12/03/2025
L2BQUAD1    =  {atquadrupole('QUAD' , 0.2754,  2.236821878111700, 'QuadLinearPass')};
L2BQUAD2    =  {atquadrupole('QUAD' , 0.2756, -1.776284723860507, 'QuadLinearPass')};
L2BQUAD3    =  {atquadrupole('QUAD' , 0.2755, -2.298942156888932, 'QuadLinearPass')};
L2BQUAD4    =  {atquadrupole('QUAD' , 0.2760,  2.053677817032618, 'QuadLinearPass')};
L2BQUAD5    =  {atquadrupole('QUAD' , 0.2755,  2.123422492334496, 'QuadLinearPass')};
L2BQUAD6    =  {atquadrupole('QUAD' , 0.2757,  2.405206272142349, 'QuadLinearPass')};
L2BQUAD7    =  {atquadrupole('QUAD' , 0.2751, -1.777990070383157, 'QuadLinearPass')};
L2BQUAD8    =  {atquadrupole('QUAD' , 0.2752,  1.424722859013002, 'QuadLinearPass')};
% Model values
% L2BQUAD1    =  {atquadrupole('QUAD' , 0.2754,  4.32881484073348, 'QuadLinearPass')};
% L2BQUAD2    =  {atquadrupole('QUAD' , 0.2756, -4.11703292520416, 'QuadLinearPass')};
% L2BQUAD3    =  {atquadrupole('QUAD' , 0.2755,  2.91344194982239, 'QuadLinearPass')};
% L2BQUAD4    =  {atquadrupole('QUAD' , 0.2760, -2.51925966101740, 'QuadLinearPass')};
% L2BQUAD5    =  {atquadrupole('QUAD' , 0.2755,  1.03682487783193, 'QuadLinearPass')};
% L2BQUAD6    =  {atquadrupole('QUAD' , 0.2757,  1.37622775981888, 'QuadLinearPass')};
% L2BQUAD7    =  {atquadrupole('QUAD' , 0.2751, -1.71896546157459, 'QuadLinearPass')};
% L2BQUAD8    =  {atquadrupole('QUAD' , 0.2752,  2.04182625706056, 'QuadLinearPass')};

% Bending Magnets
BOOINJKICK  =   {atsbend('BOOINJKICK',0.3,'BendingAngle',-0.0045,'EntranceAngle',0.0,'ExitAngle',0,'PassMethod','BendLinearPass')};
BOOINJSEPT  =   {atsbend('BOOINJSEPT',0.3,'BendingAngle',-0.27444,'EntranceAngle',0.0,'ExitAngle',0.0,'PassMethod','BendLinearPass')};
% BOOINJKICK  =   atsbend('BOOINJKICK',0.3,-0.0045,-0.0045,0,0,'BendLinearPass');
% BOOINJSEPT  =   atsbend('BOOINJSEPT',0.3,-0.2744,-0.2815,-0.0071,0,'BendLinearPass');
% DQuad in BR bends the beam by 2.16 mrad, see AP-BST-REP-0041
BRQUADBEND =   {atsbend('BOOINJSEPT',0,'BendingAngle',-0.00216/2,'EntranceAngle',0,'ExitAngle',0,'PassMethod','BendLinearPass')};
L2BBEND1    =   {atsbend('BB',0.5,'BendingAngle',0.261799,'EntranceAngle',0,'ExitAngle',0,'PassMethod','BendLinearPass')};
L2BBEND2    =   {atsbend('BB',0.5,'BendingAngle',0.261799,'EntranceAngle',0,'ExitAngle',0,'PassMethod','BendLinearPass')};

% Correctors
HCORR  = {atcorrector('HSTR',1e-6,[ 0 0 ],'CorrectorPass')};
VCORR  = {atcorrector('VSTR',1e-6,[ 0 0 ],'CorrectorPass')};
L2BC1  = [CORRECTORDRIFT HCORR VCORR CORRECTORDRIFT];
L2BC2  = [CORRECTORDRIFT HCORR VCORR CORRECTORDRIFT];
L2BC3  = [CORRECTORDRIFT HCORR VCORR CORRECTORDRIFT];
L2BC4  = [CORRECTORDRIFT HCORR VCORR CORRECTORDRIFT];
L2BC5  = [CORRECTORDRIFT HCORR VCORR CORRECTORDRIFT];
L2BC6  = [CORRECTORDRIFT HCORR VCORR CORRECTORDRIFT];

% BPM
BIBPM   =  {atmarker('BBPM', 'IdentityPass')};
L2BBPM1 =  {atmarker('BPM', 'IdentityPass')};
L2BBPM2 =  {atmarker('BPM', 'IdentityPass')};
L2BBPM3 =  {atmarker('BPM', 'IdentityPass')};
L2BBPM4 =  {atmarker('BPM', 'IdentityPass')};
L2BBPM5 =  {atmarker('BPM', 'IdentityPass')};
L2BBPM6 =  {atmarker('BPM', 'IdentityPass')};
L2BBPM7 =  {atmarker('BPM', 'IdentityPass')};

% SCREENS
SCREEN1 = {atmarker('SCREEN', 'IdentityPass')};
SCREEN2 = {atmarker('SCREEN', 'IdentityPass')};
SCREEN3 = {atmarker('SCREEN', 'IdentityPass')};
SCREEN4 = {atmarker('SCREEN', 'IdentityPass')};
% BRSCREEN = {atmarker('SCREEN', 'IdentityPass')};

% set extent [mm]
% taken from real screen settings
SCREEN1{1}.ElemData.Xmin   = -21.9551;
SCREEN1{1}.ElemData.Ymin   = -16.4701;
SCREEN1{1}.ElemData.Xmax   =  21.9542;
SCREEN1{1}.ElemData.Ymax   =  16.4701;
SCREEN1{1}.ElemData.Width  =  512;
SCREEN1{1}.ElemData.Height =  384;

% Markers
COLL    =  {atmarker('COLL', 'IdentityPass')};
IP      =  {atmarker('IP', 'IdentityPass')};

% Aperture
AP  =  {ataperture('AP', [-0.05, 0.05, -0.05, 0.05],'AperturePass')};

% Begin Lattice
LTB = [AP        L2BSTRAIGHT1As  L2BSTRAIGHT1As  L2BSTRAIGHT1As ...
L2BSTRAIGHT1As   L2BSTRAIGHT1As  L2BSTRAIGHT1As  L2BSTRAIGHT1As ...
L2BSTRAIGHT1As   L2BSTRAIGHT1As  L2BSTRAIGHT1As  L2BBPM1        ...
L2BSTRAIGHT1Bs   L2BSTRAIGHT1Bs  L2BSTRAIGHT1Bs  L2BSTRAIGHT1Bs ...
L2BSTRAIGHT1Bs   L2BSTRAIGHT1Bs  L2BSTRAIGHT1Bs  L2BSTRAIGHT1Bs ...
L2BSTRAIGHT1Bs   L2BSTRAIGHT1Bs  L2BC1           L2BSTRAIGHT1Cs ... 
L2BSTRAIGHT1Cs   L2BSTRAIGHT1Cs  L2BSTRAIGHT1Cs  L2BSTRAIGHT1Cs ... 
L2BSTRAIGHT1Cs   L2BSTRAIGHT1Cs  L2BSTRAIGHT1Cs  L2BSTRAIGHT1Cs ...
L2BSTRAIGHT1Cs   L2BQUAD1        L2BSTRAIGHT2s   L2BSTRAIGHT2s  ... 
L2BSTRAIGHT2s    L2BSTRAIGHT2s   L2BSTRAIGHT2s   L2BSTRAIGHT2s  ... 
L2BSTRAIGHT2s    L2BSTRAIGHT2s   L2BSTRAIGHT2s   L2BSTRAIGHT2s  ...
L2BQUAD2         L2BSTRAIGHT3As  L2BSTRAIGHT3As  L2BSTRAIGHT3As ...
L2BSTRAIGHT3As   L2BSTRAIGHT3As  L2BSTRAIGHT3As  L2BSTRAIGHT3As ... 
L2BSTRAIGHT3As   L2BSTRAIGHT3As  L2BSTRAIGHT3As  L2BBPM2        ... 
L2BSTRAIGHT3Bs   L2BSTRAIGHT3Bs  L2BSTRAIGHT3Bs  L2BSTRAIGHT3Bs ... 
L2BSTRAIGHT3Bs   L2BSTRAIGHT3Bs  L2BSTRAIGHT3Bs  L2BSTRAIGHT3Bs ... 
L2BSTRAIGHT3Bs   L2BSTRAIGHT3Bs  L2BC2           L2BSTRAIGHT3Cs ... 
L2BSTRAIGHT3Cs   L2BSTRAIGHT3Cs  L2BSTRAIGHT3Cs  L2BSTRAIGHT3Cs ...
SCREEN1         ...
L2BSTRAIGHT3Cs   L2BSTRAIGHT3Cs  L2BSTRAIGHT3Cs  L2BSTRAIGHT3Cs ...
L2BSTRAIGHT3Cs   L2BBEND1        L2BSTRAIGHT4s   L2BSTRAIGHT4s  ... 
L2BSTRAIGHT4s    L2BSTRAIGHT4s   L2BSTRAIGHT4s   L2BSTRAIGHT4s  ... 
L2BSTRAIGHT4s    L2BSTRAIGHT4s   L2BSTRAIGHT4s   L2BSTRAIGHT4s  ...
L2BQUAD3         L2BSTRAIGHT5As  L2BSTRAIGHT5As  L2BSTRAIGHT5As ...
L2BSTRAIGHT5As   L2BSTRAIGHT5As  L2BSTRAIGHT5As  L2BSTRAIGHT5As ...
L2BSTRAIGHT5As   L2BSTRAIGHT5As  L2BSTRAIGHT5As  L2BBPM3        ...
L2BSTRAIGHT5Bs   L2BSTRAIGHT5Bs  L2BSTRAIGHT5Bs  L2BSTRAIGHT5Bs ... 
L2BSTRAIGHT5Bs   L2BSTRAIGHT5Bs  L2BSTRAIGHT5Bs  L2BSTRAIGHT5Bs ... 
L2BSTRAIGHT5Bs   L2BSTRAIGHT5Bs  L2BC3           L2BSTRAIGHT5Cs ...
L2BSTRAIGHT5Cs   L2BSTRAIGHT5Cs  L2BSTRAIGHT5Cs  L2BSTRAIGHT5Cs ...
L2BSTRAIGHT5Cs   L2BSTRAIGHT5Cs  L2BSTRAIGHT5Cs  L2BSTRAIGHT5Cs ...
L2BSTRAIGHT5Cs   L2BQUAD4        L2BSTRAIGHT6As  L2BSTRAIGHT6As ...
L2BSTRAIGHT6As   L2BSTRAIGHT6As  L2BSTRAIGHT6As  COLL           ... 
SCREEN2         ...
L2BSTRAIGHT6Bs   L2BSTRAIGHT6Bs  L2BSTRAIGHT6Bs  L2BSTRAIGHT6Bs ... 
L2BSTRAIGHT6Bs   L2BBEND2        L2BSTRAIGHT7As  L2BSTRAIGHT7As ... 
L2BSTRAIGHT7As   L2BSTRAIGHT7As  L2BSTRAIGHT7As  L2BSTRAIGHT7As ... 
L2BSTRAIGHT7As   L2BSTRAIGHT7As  L2BSTRAIGHT7As  L2BSTRAIGHT7As ... 
L2BBPM4          L2BSTRAIGHT7Bs  L2BSTRAIGHT7Bs  L2BSTRAIGHT7Bs ... 
L2BSTRAIGHT7Bs   L2BSTRAIGHT7Bs  L2BSTRAIGHT7Bs  L2BSTRAIGHT7Bs ... 
L2BSTRAIGHT7Bs   L2BSTRAIGHT7Bs  L2BSTRAIGHT7Bs  L2BC4          ... 
L2BSTRAIGHT7Cs   L2BSTRAIGHT7Cs  L2BSTRAIGHT7Cs  L2BSTRAIGHT7Cs ... 
L2BSTRAIGHT7Cs   L2BSTRAIGHT7Cs  L2BSTRAIGHT7Cs  L2BSTRAIGHT7Cs ... 
L2BSTRAIGHT7Cs   L2BSTRAIGHT7Cs  L2BQUAD5        L2BSTRAIGHT8As ... 
L2BSTRAIGHT8As   L2BSTRAIGHT8As  L2BSTRAIGHT8As  L2BSTRAIGHT8As ...
L2BSTRAIGHT8As   L2BSTRAIGHT8As  L2BSTRAIGHT8As  L2BSTRAIGHT8As ... 
L2BSTRAIGHT8As   L2BBPM5         L2BSTRAIGHT8Bs  L2BSTRAIGHT8Bs ...
L2BSTRAIGHT8Bs   L2BSTRAIGHT8Bs  L2BSTRAIGHT8Bs  L2BSTRAIGHT8Bs ... 
L2BSTRAIGHT8Bs   L2BSTRAIGHT8Bs  L2BSTRAIGHT8Bs  L2BSTRAIGHT8Bs ... 
L2BSTRAIGHT8WALLs    L2BSTRAIGHT8WALLs  L2BSTRAIGHT8WALLs       ... 
L2BSTRAIGHT8WALLs    L2BSTRAIGHT8WALLs  L2BSTRAIGHT8WALLs       ... 
L2BSTRAIGHT8WALLs    L2BSTRAIGHT8WALLs  L2BSTRAIGHT8WALLs       ...
L2BSTRAIGHT8WALLs    L2BSTRAIGHT8Cs     L2BSTRAIGHT8Cs          ...
L2BSTRAIGHT8Cs   L2BSTRAIGHT8Cs  L2BSTRAIGHT8Cs  L2BSTRAIGHT8Cs ...
L2BSTRAIGHT8Cs   L2BSTRAIGHT8Cs  L2BSTRAIGHT8Cs  L2BSTRAIGHT8Cs ...
L2BQUAD6         L2BSTRAIGHT9As  L2BSTRAIGHT9As  L2BSTRAIGHT9As ...
L2BSTRAIGHT9As   L2BSTRAIGHT9As  L2BSTRAIGHT9As  L2BSTRAIGHT9As ...
L2BSTRAIGHT9As   L2BSTRAIGHT9As  L2BSTRAIGHT9As  L2BC5          ... 
L2BSTRAIGHT9Bs   L2BSTRAIGHT9Bs  L2BSTRAIGHT9Bs  L2BSTRAIGHT9Bs ... 
L2BSTRAIGHT9Bs   L2BSTRAIGHT9Bs  L2BSTRAIGHT9Bs  L2BSTRAIGHT9Bs ... 
L2BSTRAIGHT9Bs   L2BSTRAIGHT9Bs  L2BBPM6         L2BSTRAIGHT9Cs ... 
L2BSTRAIGHT9Cs   L2BSTRAIGHT9Cs  L2BSTRAIGHT9Cs  L2BSTRAIGHT9Cs ... 
L2BSTRAIGHT9Cs   L2BSTRAIGHT9Cs  L2BSTRAIGHT9Cs  L2BSTRAIGHT9Cs ... 
L2BSTRAIGHT9Cs   L2BQUAD7        L2BSTRAIGHT10s  L2BSTRAIGHT10s ... 
L2BSTRAIGHT10s   SCREEN3         ...
L2BSTRAIGHT10s  L2BSTRAIGHT10s  L2BSTRAIGHT10s ... 
L2BSTRAIGHT10s   L2BSTRAIGHT10s  L2BSTRAIGHT10s  L2BSTRAIGHT10s ... 
L2BQUAD8         L2BSTRAIGHT11As L2BSTRAIGHT11As L2BSTRAIGHT11As    ...
L2BSTRAIGHT11As  L2BSTRAIGHT11As L2BSTRAIGHT11As L2BSTRAIGHT11As    ... 
L2BSTRAIGHT11As  L2BSTRAIGHT11As L2BSTRAIGHT11As L2BC6          ... 
L2BSTRAIGHT11Bs  L2BSTRAIGHT11Bs L2BSTRAIGHT11Bs L2BSTRAIGHT11Bs... 
L2BSTRAIGHT11Bs  L2BSTRAIGHT11Bs L2BSTRAIGHT11Bs L2BSTRAIGHT11Bs... 
L2BSTRAIGHT11Bs  L2BSTRAIGHT11Bs L2BBPM7         L2BSTRAIGHT11Cs... 
SCREEN4         ...
L2BSTRAIGHT11Cs  L2BSTRAIGHT11Cs L2BSTRAIGHT11Cs L2BSTRAIGHT11Cs... 
L2BSTRAIGHT11Cs  L2BSTRAIGHT11Cs L2BSTRAIGHT11Cs L2BSTRAIGHT11Cs... 
L2BSTRAIGHT11Cs  BOOINJDRIFTs    BOOINJDRIFTs   ... 
BOOINJDRIFTs     BOOINJDRIFTs    BOOINJDRIFTs    BOOINJDRIFTs   ... 
BOOINJDRIFTs     BOOINJDRIFTs    BOOINJDRIFTs    BOOINJDRIFTs   ... 
BOOINJSEPT       BOOINJSEPTDRIFTs   BOOINJSEPTDRIFTs   BOOINJSEPTDRIFTs... 
BOOINJSEPTDRIFTs BOOINJSEPTDRIFTs   BOOINJSEPTDRIFTs   BOOINJSEPTDRIFTs... 
BOOINJSEPTDRIFTs BOOINJSEPTDRIFTs   BOOINJSEPTDRIFTs   BRQUADBEND DQUD   BRQUADBEND  ... 
BOOINJKICKDRIFT1s   BOOINJKICKDRIFT1s    BOOINJKICKDRIFT1s      ... 
BOOINJKICKDRIFT1s   BOOINJKICKDRIFT1s    BOOINJKICKDRIFT1s      ... 
BOOINJKICKDRIFT1s   BOOINJKICKDRIFT1s    BOOINJKICKDRIFT1s      ... 
BOOINJKICKDRIFT1s   BOOINJKICK  BOOINJKICKDRIFT2s    SCREEN1         ...
BOOINJKICKDRIFT2s... 
BOOINJKICKDRIFT2s   BOOINJKICKDRIFT2s    BOOINJKICKDRIFT2s      ... 
BOOINJKICKDRIFT2s   BOOINJKICKDRIFT2s    BOOINJKICKDRIFT2s      ... 
BOOINJKICKDRIFT2s   BOOINJKICKDRIFT2s    IP           BIBPM ];

% buildlat(LTB);
THERING = LTB;

% just adjust the drift lengths according to the new quad length
oldlen = 0.25;
q = 1;
for n = 1:length(THERING)
   % only adjust ltb quads
    if q > 8
      break 
    end
    % get current element
    elem = THERING{n};
    % check for quadrupoles
    if strcmp(elem.FamName, 'QUAD')
       % before and after drift elements
       before = THERING{n-1};
%        beforelen = before.Length;
       after = THERING{n+1};
%        afterlen = after.Length;
%        quad = THERING{n};
       % oldlen = elem.Length;
       newlen = elem.Length;
       % reduce each drift by this amount
       driftlendiff = (newlen - oldlen) / 2;
       % multiply k by this amount
       % kdiff = (oldlen / newlen);
       kdiff = 1.0;
       % JR values are now matched for exact length quads
       % make new elements
       before_new = {atdrift([before.FamName 'eff'], before.Length - driftlendiff, 'DriftPass')};
       quad_new = {atquadrupole('QUAD', newlen, elem.K * kdiff, 'QuadLinearPass')};
       after_new = {atdrift([after.FamName 'eff'], after.Length - driftlendiff, 'DriftPass')};
       % change the line
       LTB(n-1) = before_new;
       LTB(n) = quad_new;
       LTB(n+1) = after_new;
       % increment number of quads
       q = q + 1;
   end
end

% build new line
% buildlat(LTB);
THERING = LTB;

evalin('caller','global THERING GLOBVAL');
disp('** Done **');
